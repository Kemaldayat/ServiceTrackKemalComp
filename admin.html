<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tambah Layanan Baru - Kemal Computer</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <link rel="stylesheet" href="css/style.css"> </head>
<body>
    <div class="container add-service-container">
        <header>
            <h1>Tambah Layanan Baru</h1>
            <button class="back-button" onclick="window.location.href='dashboard.html'"><i class="fas fa-arrow-left"></i> Kembali ke Dashboard</button>
        </header>

        <form id="addServiceForm">
            <div>
                <label for="inputNama">Nama Pelanggan:</label>
                <input type="text" id="inputNama" required>
            </div>
            <div>
                <label for="inputDevice">Jenis Device (misal: Laptop Asus, HP Samsung A50):</label>
                <input type="text" id="inputDevice" required>
            </div>
            <div>
                <label for="inputKerusakan">Deskripsi Kerusakan:</label>
                <textarea id="inputKerusakan" rows="3" required></textarea>
            </div>
            <div>
                <label for="inputNomorHp">Nomor HP (format 62xxxxxxxxxx):</label>
                <input type="tel" id="inputNomorHp" placeholder="Contoh: 6281234567890" required>
            </div>
            <div>
                <label for="inputStatus">Status:</label>
                <select id="inputStatus" required>
                    <option value="Menunggu">Menunggu</option>
                    <option value="Proses">Proses</option>
                    <option value="Selesai">Selesai</option>
                    <option value="Diambil">Diambil</option>
                </select>
            </div>
            <button type="submit" onclick="addService()">Tambahkan Service</button>
        </form>
    </div>

    <script type="module">
        // Firebase Configuration (GANTI DENGAN KONFIGURASI ANDA SENDIRI)
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_AUTH_DOMAIN",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_STORAGE_BUCKET",
            messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
            appId: "YOUR_APP_ID",
            databaseURL: "YOUR_DATABASE_URL"
        };

        // Initialize Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-app.js";
        import { getDatabase, ref, set } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-database.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-auth.js";


        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const auth = getAuth(app);

        // Auth state listener for admin check
        onAuthStateChanged(auth, (user) => {
            if (user) {
                if (user.email !== "dayatkemal16@gmail.com") {
                    alert("Anda tidak memiliki izin akses ke halaman ini.");
                    window.location.href = 'index.html';
                }
            } else {
                alert("Anda belum login atau sesi telah berakhir.");
                window.location.href = 'index.html';
            }
        });

        // Function to generate a unique service code
        function generateServiceCode() {
            // Using timestamp + random string for uniqueness
            return 'KC-' + Date.now().toString(36) + Math.random().toString(36).substring(2, 6).toUpperCase();
        }

        window.addService = async () => {
            const nama = document.getElementById('inputNama').value.trim();
            const device = document.getElementById('inputDevice').value.trim(); // Hanya satu field 'device'
            const kerusakan = document.getElementById('inputKerusakan').value.trim();
            const nomorHp = document.getElementById('inputNomorHp').value.trim();
            const status = document.getElementById('inputStatus').value;

            if (!nama || !device || !kerusakan || !nomorHp || !status) {
                alert('Semua kolom wajib diisi!');
                return;
            }

            if (!/^\d+$/.test(nomorHp) || !nomorHp.startsWith('62')) {
                alert('Nomor HP tidak valid. Gunakan format dimulai 62 (misal: 62812...) dan hanya angka.');
                return;
            }

            const serviceCode = generateServiceCode();

            try {
                await set(ref(db, `antrian/${serviceCode}`), {
                    nama: nama,
                    device: device, // Hanya properti 'device' yang disimpan
                    kerusakan: kerusakan,
                    nomorHp: nomorHp,
                    status: status,
                    timestamp: new Date().toISOString() // Simpan timestamp saat dibuat
                });
                alert('Layanan baru berhasil ditambahkan dengan kode: ' + serviceCode);
                // Bersihkan formulir
                document.getElementById('addServiceForm').reset();
                document.getElementById('inputStatus').value = 'Menunggu'; // Reset status ke default

                // Redirect ke dashboard setelah berhasil menambah
                window.location.href = 'dashboard.html';

            } catch (error) {
                console.error("Error menambahkan layanan baru:", error);
                alert('Gagal menambahkan layanan baru. Silakan coba lagi.');
            }
        };

        // Prevent form submission from reloading page (if you used <form> element)
        document.getElementById('addServiceForm').addEventListener('submit', (e) => {
            e.preventDefault();
            // addService(); // It's already called by onclick, but good practice for form submission
        });
    </script>
</body>
</html>
