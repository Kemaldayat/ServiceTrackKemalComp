<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard Service Kemal Computer</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    /* Custom styles for the Inter font family */
    body {
      font-family: 'Inter', sans-serif;
    }
    /* Ensures table is scrollable on smaller screens */
    .table-container {
      overflow-x: auto;
      -webkit-overflow-scrolling: touch; /* Smooth scrolling on iOS */
    }
    /* Styling for input and select elements within the data table when in edit mode */
    #dataTable input, #dataTable select {
        min-width: 80px; /* Minimum width for inputs */
        max-width: 100%; /* Maximum width, ensures responsiveness */
        box-sizing: border-box; /* Include padding and border in the element's total width */
        padding: 0.25rem 0.5rem; /* Smaller padding for inputs within table cells */
        border: 1px solid #d1d5db; /* Tailwind's border-gray-300 */
        border-radius: 0.25rem; /* Tailwind's rounded-md */
        font-size: 0.875rem; /* Tailwind's text-sm */
    }
    /* Styling for status badges in non-edit mode */
    .status-badge {
        padding: 0.25rem 0.75rem;
        border-radius: 9999px; /* Fully rounded for a pill shape */
        font-size: 0.75rem; /* text-xs */
        font-weight: 600; /* font-semibold */
        display: inline-block;
        white-space: nowrap; /* Prevents text from wrapping */
    }
    /* Specific background and text colors for different status types */
    .status-selesai { background-color: #d1fae5; color: #065f46; } /* Tailwind's green-100 and green-800 */
    .status-proses { background-color: #fffbeb; color: #b45309; } /* Tailwind's yellow-100 and yellow-800 */
    .status-menunggu { background-color: #fee2e2; color: #991b1b; } /* Tailwind's red-100 and red-800 */
  </style>
</head>
<body class="bg-gray-100 p-4 sm:p-8 flex flex-col items-center min-h-screen">
  <div class="container bg-white p-6 sm:p-8 rounded-xl shadow-lg max-w-4xl w-full">
    <h2 class="text-2xl font-bold text-center text-gray-800 mb-6">Data Antrian Service Kemal Computer</h2>

    <div class="flex flex-col sm:flex-row justify-between mb-4 gap-2">
      <input type="text" id="search" placeholder="Cari berdasarkan kode / nama / device..."
        class="w-full sm:w-2/3 p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-gray-700" />
      <button id="refreshBtn" class="w-full sm:w-auto bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-6 rounded-lg transition duration-300 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-blue-500">
        ðŸ”„ Refresh
      </button>
    </div>

    <div class="table-container">
      <table id="dataTable" class="min-w-full bg-white border border-gray-200 rounded-lg overflow-hidden">
        <thead>
          <tr class="bg-blue-600 text-white text-left">
            <th class="py-3 px-4 uppercase font-semibold text-sm rounded-tl-lg">Kode</th>
            <th class="py-3 px-4 uppercase font-semibold text-sm">Nama</th>
            <th class="py-3 px-4 uppercase font-semibold text-sm">Device</th>
            <th class="py-3 px-4 uppercase font-semibold text-sm">Keluhan</th>
            <th class="py-3 px-4 uppercase font-semibold text-sm">Status</th>
            <th class="py-3 px-4 uppercase font-semibold text-sm rounded-tr-lg">Aksi</th>
          </tr>
        </thead>
        <tbody id="dataBody" class="divide-y divide-gray-200"></tbody>
      </table>
    </div>

    <div class="flex flex-col sm:flex-row justify-end gap-4 mt-8 w-full">
      <button onclick="window.location.href='add-service.html'"
        class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg transition duration-300 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-opacity-50">
        Tambah Service Baru
      </button>
      <button class="logout bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-6 rounded-lg transition duration-300 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-opacity-50">
        Logout
      </button>
    </div>
  </div>

  <div id="customModal" class="fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center hidden z-50">
    <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full text-center">
      <p id="modalMessage" class="text-gray-800 text-lg mb-4"></p>
      <div id="modalActions" class="flex justify-center gap-4">
        <button id="modalConfirmBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg hidden">Ya</button>
        <button id="modalCancelBtn" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-lg hidden">Batal</button>
        <button id="modalCloseBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg hidden">Oke</button>
      </div>
    </div>
  </div>

  <script type="module">
    // =====================================================================================================================================================================
    // IMPORTANT: REPLACE WITH YOUR ACTUAL FIREBASE CONFIGURATION!
    // You can find this in your Firebase Console > Project settings > Your apps > Firebase SDK snippet > Config
    // =====================================================================================================================================================================
    const firebaseConfig = {
      apiKey: "AIzaSyDRvkYXHUb42q2H8F_2687CTihtDDNuYQ4",
      authDomain: "website-track-service.firebaseapp.com",
      databaseURL: "https://website-track-service-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "website-track-service",
      storageBucket: "website-track-service.firebasestorage.app",
      messagingSenderId: "87573564376",
      appId: "1:87573564376:web:c93c07f0506d00535a00ad",
      measurementId: "G-64T8XNWK5F"
    };
    // =====================================================================================================================================================================

    // Import necessary Firebase modules
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-app.js";
    import { getDatabase, ref, onValue, remove, update } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-database.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-auth.js";

    // Initialize Firebase app and services
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const auth = getAuth(app);

    // Get references to DOM elements
    const dataTable = document.getElementById('dataTable');
    const dataBody = document.getElementById('dataBody');
    const searchInput = document.getElementById('search');
    const refreshBtn = document.getElementById('refreshBtn');
    const logoutBtn = document.querySelector('.logout');

    // Get references to custom modal elements
    const customModal = document.getElementById('customModal');
    const modalMessage = document.getElementById('modalMessage');
    const modalConfirmBtn = document.getElementById('modalConfirmBtn');
    const modalCancelBtn = document.getElementById('modalCancelBtn');
    const modalCloseBtn = document.getElementById('modalCloseBtn');

    let currentData = {}; // Stores the fetched data for searching and filtering

    // --- User Authentication Check ---
    // Listens for changes in the user's sign-in state
    onAuthStateChanged(auth, (user) => {
      if (user) {
        console.log("User is logged in:", user.uid);
        fetchServiceData(); // Fetch data if user is logged in
      } else {
        console.log("User is not logged in, redirecting to login page...");
        // Redirects to your login page. Ensure you have a 'login.html' file.
        window.location.href = 'login.html';
      }
    });

    // --- Fetching and Displaying Data from Firebase ---
    // Sets up a real-time listener for changes in the 'antrian' path in Firebase
    function fetchServiceData() {
      const antrianRef = ref(db, 'antrian');
      onValue(antrianRef, (snapshot) => {
        currentData = {}; // Clear previous data
        if (snapshot.exists()) {
          currentData = snapshot.val(); // Get all data as an object
          renderTable(currentData); // Re-render the table with the latest data
        } else {
          dataBody.innerHTML = '<tr><td colspan="6" class="py-4 text-center text-gray-500">Tidak ada data service.</td></tr>';
        }
      });
    }

    // --- Rendering the Data Table ---
    // Populates the table body with service data, applying search filters
    function renderTable(data) {
      dataBody.innerHTML = ''; // Clear existing table rows
      const searchTerm = searchInput.value.toLowerCase();

      let hasFilteredData = false;
      // Iterate through each service entry
      for (const kode in data) {
        const item = data[kode];
        // Filter based on search term (code, name, device, complaint, status)
        if (
          kode.toLowerCase().includes(searchTerm) ||
          (item.nama && item.nama.toLowerCase().includes(searchTerm)) ||
          (item.device && item.device.toLowerCase().includes(searchTerm)) || /* Changed from item.barang */
          (item.kerusakan && item.kerusakan.toLowerCase().includes(searchTerm)) ||
          (item.status && item.status.toLowerCase().includes(searchTerm))
        ) {
          hasFilteredData = true;
          const row = document.createElement('tr');
          row.id = `row-${kode}`; // Assign an ID for easy access (e.g., for editing)
          row.className = 'hover:bg-gray-50 transition duration-150 ease-in-out';

          // Determine the status badge class based on the item's status
          let statusClass = '';
          if (item.status && item.status.toLowerCase().includes('selesai')) {
            statusClass = 'status-selesai';
          } else if (item.status && item.status.toLowerCase().includes('proses')) {
            statusClass = 'status-proses';
          } else {
            statusClass = 'status-menunggu'; // Default: Menunggu
          }

          // Populate the row with data and action buttons
          row.innerHTML = `
            <td class="py-3 px-4 text-gray-700 font-medium whitespace-nowrap" data-field="kode">${kode}</td>
            <td class="py-3 px-4 text-gray-700 whitespace-nowrap" data-field="nama">${item.nama || '-'}</td>
            <td class="py-3 px-4 text-gray-700 whitespace-nowrap" data-field="device">${item.device || '-'}</td> <td class="py-3 px-4 text-gray-700" data-field="kerusakan">${item.kerusakan || '-'}</td>
            <td class="py-3 px-4 whitespace-nowrap">
              <span class="status-badge ${statusClass}" data-field="status">${item.status || '-'}</span>
            </td>
            <td class="py-3 px-4 whitespace-nowrap">
              <button class="edit-btn bg-blue-500 hover:bg-blue-600 text-white text-sm font-semibold py-2 px-4 rounded-md mr-2 transition duration-200">Edit</button>
              <button class="delete-btn bg-red-500 hover:bg-red-600 text-white text-sm font-semibold py-2 px-4 rounded-md transition duration-200">Hapus</button>
            </td>
          `;
          dataBody.appendChild(row);
        }
      }

      // Display message if no data matches the search term
      if (!hasFilteredData) {
        dataBody.innerHTML = '<tr><td colspan="6" class="py-4 text-center text-gray-500">Tidak ada data yang cocok dengan pencarian Anda.</td></tr>';
      }
    }

    // --- Main Event Listeners ---
    refreshBtn.addEventListener('click', fetchServiceData); // Refresh data on button click
    searchInput.addEventListener('input', () => renderTable(currentData)); // Filter table on search input change

    // Logout button event listener
    logoutBtn.addEventListener('click', async () => {
      showModal('Konfirmasi Logout', 'Apakah Anda yakin ingin logout?', true, async () => {
        try {
          await signOut(auth); // Sign out the user
          // Redirection will be handled by the onAuthStateChanged listener
        } catch (error) {
          console.error("Error logging out:", error);
          showModal('Error', 'Terjadi kesalahan saat logout. Silakan coba lagi.', false);
        }
      });
    });

    // Event delegation for Edit, Save, Cancel, and Delete buttons within the table
    dataTable.addEventListener('click', (event) => {
      const target = event.target;
      const row = target.closest('tr'); // Get the closest table row
      if (!row) return; // Exit if click wasn't on a row

      const kode = row.id.replace('row-', ''); // Extract service code from row ID

      if (target.classList.contains('edit-btn')) {
        toggleEditMode(row, kode, true); // Activate edit mode for the row
      } else if (target.classList.contains('save-btn')) {
        saveRow(row, kode); // Save changes to Firebase
      } else if (target.classList.contains('cancel-btn')) {
        toggleEditMode(row, kode, false); // Cancel edit mode, revert changes
      } else if (target.classList.contains('delete-btn')) {
        // Show confirmation modal before deleting
        showModal('Konfirmasi Hapus', `Apakah Anda yakin ingin menghapus antrian dengan kode <strong>${kode}</strong>?`, true, () => deleteRow(kode));
      }
    });

    // --- In-place Editing Logic (Toggle Edit/View Mode for a Row) ---
    function toggleEditMode(row, kode, isEditMode) {
      const fields = ['nama', 'device', 'kerusakan', 'status']; // Changed from 'barang' to 'device'
      const currentItem = currentData[kode]; // Get the current data for the specific item

      fields.forEach(field => {
        const cell = row.querySelector(`[data-field="${field}"]`);
        if (!cell) return; // Skip if cell not found

        if (isEditMode) {
          let inputElement;
          if (field === 'status') {
            // Use a dropdown (select) for the status field
            inputElement = document.createElement('select');
            inputElement.className = 'w-full p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-1 focus:ring-blue-400 text-gray-700';
            const options = ['Menunggu', 'Proses', 'Selesai'];
            options.forEach(optionText => {
              const option = document.createElement('option');
              option.value = optionText;
              option.textContent = optionText;
              // Select the current status in the dropdown
              if (currentItem[field] && currentItem[field].toLowerCase() === optionText.toLowerCase()) {
                option.selected = true;
              }
              inputElement.appendChild(option);
            });
          } else {
            // Use a text input for other fields
            inputElement = document.createElement('input');
            inputElement.type = 'text';
            inputElement.value = currentItem[field] || ''; // Set initial value
            inputElement.className = 'w-full p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-1 focus:ring-blue-400 text-gray-700';
          }
          cell.dataset.originalValue = currentItem[field] || ''; // Store original value for cancel option
          cell.innerHTML = ''; // Clear cell content
          cell.appendChild(inputElement); // Append the input/select element
        } else {
          // Revert to display mode
          const displayValue = currentItem[field] || '-'; // Get the current value from data
          if (field === 'status') {
              // Apply status badge styling when reverting status
              let statusClass = '';
              if (displayValue.toLowerCase().includes('selesai')) {
                statusClass = 'status-selesai';
              } else if (displayValue.toLowerCase().includes('proses')) {
                statusClass = 'status-proses';
              } else {
                statusClass = 'status-menunggu';
              }
              cell.innerHTML = `<span class="status-badge ${statusClass}">${displayValue}</span>`;
          } else {
              cell.innerHTML = displayValue; // Display text for other fields
          }
        }
      });

      // Update action buttons in the last cell
      const actionCell = row.querySelector('td:last-child');
      if (isEditMode) {
        actionCell.innerHTML = `
          <button class="save-btn bg-green-500 hover:bg-green-600 text-white text-sm font-semibold py-2 px-4 rounded-md mr-2 transition duration-200">Simpan</button>
          <button class="cancel-btn bg-gray-400 hover:bg-gray-500 text-white text-sm font-semibold py-2 px-4 rounded-md transition duration-200">Batal</button>
        `;
      } else {
        // Revert to Edit and Delete buttons
        actionCell.innerHTML = `
          <button class="edit-btn bg-blue-500 hover:bg-blue-600 text-white text-sm font-semibold py-2 px-4 rounded-md mr-2 transition duration-200">Edit</button>
          <button class="delete-btn bg-red-500 hover:bg-red-600 text-white text-sm font-semibold py-2 px-4 rounded-md transition duration-200">Hapus</button>
        `;
      }
    }

    // --- Saving Edited Row to Firebase ---
    async function saveRow(row, kode) {
      const updatedData = {
        nama: row.querySelector('[data-field="nama"] input')?.value || '',
        device: row.querySelector('[data-field="device"] input')?.value || '', /* Changed from barang to device */
        kerusakan: row.querySelector('[data-field="kerusakan"] input')?.value || '',
        status: row.querySelector('[data-field="status"] select')?.value || '',
      };

      // Simple validation: ensure all required fields are filled
      if (!updatedData.nama || !updatedData.device || !updatedData.kerusakan || !updatedData.status) { /* Changed from barang */
        showModal('Error', 'Semua kolom (Nama, Device, Keluhan, Status) harus diisi.', false);
        return;
      }

      try {
        // Update data in Firebase Realtime Database
        await update(ref(db, 'antrian/' + kode), updatedData);
        showModal('Berhasil!', 'Data antrian berhasil diperbarui.', false);
        // The onValue listener will automatically re-render the table with the updated data
      } catch (error) {
        console.error("Error updating document:", error);
        showModal('Error', 'Gagal memperbarui data antrian. Silakan coba lagi.', false);
      }
    }

    // --- Deleting Row from Firebase ---
    async function deleteRow(kode) {
      try {
        // Remove data from Firebase Realtime Database
        await remove(ref(db, 'antrian/' + kode));
        showModal('Berhasil!', 'Antrian berhasil dihapus.', false);
        // The onValue listener will automatically re-render the table
      } catch (error) {
        console.error("Error deleting document:", error);
        showModal('Error', 'Gagal menghapus antrian. Silakan coba lagi.', false);
      }
    }

    // --- Custom Modal Function ---
    // Displays a custom modal for confirmations or messages
    function showModal(title, message, isConfirm, onConfirmCallback = null) {
      modalMessage.innerHTML = `${title}<br><span class="text-sm font-normal">${message}</span>`;
      customModal.classList.remove('hidden'); // Show the modal

      // Hide all default modal buttons
      modalConfirmBtn.classList.add('hidden');
      modalCancelBtn.classList.add('hidden');
      modalCloseBtn.classList.add('hidden');

      if (isConfirm) {
        // If it's a confirmation modal, show 'Yes' and 'Cancel' buttons
        modalConfirmBtn.classList.remove('hidden');
        modalCancelBtn.classList.remove('hidden');
        modalConfirmBtn.onclick = () => {
          onConfirmCallback(); // Execute callback on 'Yes' click
          customModal.classList.add('hidden'); // Hide modal
        };
        modalCancelBtn.onclick = () => {
          customModal.classList.add('hidden'); // Hide modal on 'Cancel'
        };
      } else {
        // If it's just an info modal, show 'Oke' button
        modalCloseBtn.classList.remove('hidden');
        modalCloseBtn.onclick = () => {
          customModal.classList.add('hidden'); // Hide modal on 'Oke'
        };
      }
    }
  </script>
</body>
</html>
