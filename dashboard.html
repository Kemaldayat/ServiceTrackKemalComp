<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Admin - Kemal Computer</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <link rel="stylesheet" href="css/style.css"> </head>
<body>
    <div class="container">
        <header>
            <h1>Dashboard Admin - Kemal Computer</h1>
            <div class="header-buttons">
                <button class="refresh-button" onclick="refreshData()"><i class="fas fa-sync-alt"></i> Perbarui Data</button>
                <button class="logout-button" onclick="logoutAdmin()"><i class="fas fa-sign-out-alt"></i> Logout</button>
            </div>
        </header>

        <section class="controls">
            <input type="text" id="searchInput" placeholder="Cari Kode, Nama, Device, Kerusakan, atau HP..." onkeyup="filterTable()">
        </section>

        <div class="table-responsive">
            <table id="serviceTable">
                <thead>
                    <tr>
                        <th>Kode Service</th>
                        <th>Nama Pelanggan</th>
                        <th>Jenis Device</th>
                        <th>Deskripsi Kerusakan</th>
                        <th>Nomor HP</th>
                        <th>Status</th>
                        <th>Aksi</th>
                    </tr>
                </thead>
                <tbody>
                    </tbody>
            </table>
        </div>

        <button class="add-new-button" onclick="window.location.href='admin.html'"><i class="fas fa-plus"></i> Tambah Service Baru</button>
    </div>

    <div id="customModal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeModal()">&times;</span>
            <p id="modalMessage"></p>
            <div class="modal-buttons" id="modalButtons">
                </div>
        </div>
    </div>

    <script type="module">
        // Firebase Configuration (GANTI DENGAN KONFIGURASI ANDA SENDIRI)
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_AUTH_DOMAIN",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_STORAGE_BUCKET",
            messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
            appId: "YOUR_APP_ID",
            databaseURL: "YOUR_DATABASE_URL"
        };

        // Initialize Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-app.js";
        import { getDatabase, ref, onValue, set, remove } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-database.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-auth.js";

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const auth = getAuth(app);

        let servicesData = {};
        let editingRowId = null;

        // Auth state listener for admin check
        onAuthStateChanged(auth, (user) => {
            if (user) {
                if (user.email === "dayatkemal16@gmail.com") { // ADMIN EMAIL CHECK
                    loadServices();
                } else {
                    alert("Anda tidak memiliki izin akses ke halaman ini.");
                    window.location.href = 'login.html'; // Redirect non-admin to login page
                }
            } else {
                alert("Anda belum login atau sesi telah berakhir.");
                window.location.href = 'login.html'; // Redirect to login page
            }
        });

        window.logoutAdmin = async () => {
            try {
                await signOut(auth);
                alert("Anda telah logout.");
                window.location.href = 'login.html';
            } catch (error) {
                console.error("Error logging out:", error);
                alert("Gagal logout. Silakan coba lagi.");
            }
        };

        window.loadServices = () => {
            const servicesRef = ref(db, 'antrian');
            onValue(servicesRef, (snapshot) => {
                const tableBody = document.getElementById('serviceTable').getElementsByTagName('tbody')[0];
                tableBody.innerHTML = '';

                servicesData = {};

                if (snapshot.exists()) {
                    snapshot.forEach((childSnapshot) => {
                        const serviceCode = childSnapshot.key;
                        const service = childSnapshot.val();
                        servicesData[serviceCode] = service;

                        let statusBadgeClass = '';
                        switch (service.status) {
                            case 'Menunggu': statusBadgeClass = 'status-waiting'; break;
                            case 'Proses': statusBadgeClass = 'status-process'; break;
                            case 'Selesai': statusBadgeClass = 'status-finished'; break;
                            case 'Diambil': statusBadgeClass = 'status-picked-up'; break;
                            default: statusBadgeClass = '';
                        }

                        const row = tableBody.insertRow();
                        row.setAttribute('data-id', serviceCode);
                        row.innerHTML = `
                            <td>${serviceCode}</td>
                            <td data-field="nama">${service.nama}</td>
                            <td data-field="device">${service.device || '-'}</td>
                            <td data-field="kerusakan">${service.kerusakan}</td>
                            <td data-field="nomorHp">${service.nomorHp || '-'}</td>
                            <td data-field="status"><span class="status-badge ${statusBadgeClass}">${service.status}</span></td>
                            <td class="action-buttons">
                                <button class="edit-button" onclick="editRow('${serviceCode}')">Edit</button>
                                <button class="delete-button" onclick="deleteService('${serviceCode}')">Hapus</button>
                            </td>
                        `;
                    });
                } else {
                    const row = tableBody.insertRow();
                    row.className = 'no-data-row';
                    row.innerHTML = '<td colspan="7" style="text-align:center;">Tidak ada data service.</td>';
                }
                filterTable();
            }, (error) => {
                console.error("Error loading services:", error);
                showModal("Gagal memuat data service. Silakan refresh.", "info");
            });
        };

        window.refreshData = () => {
            loadServices();
            showModal("Data diperbarui.", "info");
        };

        window.filterTable = () => {
            const input = document.getElementById('searchInput');
            const filter = input.value.toLowerCase();
            const tableBody = document.getElementById('serviceTable').getElementsByTagName('tbody')[0];
            const rows = tableBody.getElementsByTagName('tr');

            let found = false;
            let hasActualData = false;

            for (let i = 0; i < rows.length; i++) {
                if (!rows[i].classList.contains('no-data-row')) {
                    hasActualData = true;
                    break;
                }
            }

            for (let i = 0; i < rows.length; i++) {
                if (rows[i].classList.contains('no-data-row')) {
                    rows[i].style.display = 'none';
                    continue;
                }

                const serviceCode = rows[i].cells[0].textContent.toLowerCase();
                const nama = rows[i].cells[1].textContent.toLowerCase();
                const device = rows[i].cells[2].textContent.toLowerCase();
                const kerusakan = rows[i].cells[3].textContent.toLowerCase();
                const nomorHp = rows[i].cells[4].textContent.toLowerCase();
                const status = rows[i].cells[5].textContent.toLowerCase();

                if (serviceCode.includes(filter) || nama.includes(filter) || device.includes(filter) || kerusakan.includes(filter) || nomorHp.includes(filter) || status.includes(filter)) {
                    rows[i].style.display = "";
                    found = true;
                } else {
                    rows[i].style.display = "none";
                }
            }

            const existingNoDataRow = tableBody.querySelector('.no-data-row');
            if (existingNoDataRow) {
                existingNoDataRow.remove();
            }

            if (!found && hasActualData) {
                const row = tableBody.insertRow();
                row.className = 'no-data-row';
                row.innerHTML = '<td colspan="7" style="text-align:center; color:#DC3545;">Data tidak ditemukan.</td>';
            } else if (!hasActualData && filter === '') {
                const row = tableBody.insertRow();
                row.className = 'no-data-row';
                row.innerHTML = '<td colspan="7" style="text-align:center;">Tidak ada data service.</td>';
            }
        };


        window.editRow = (serviceCode) => {
            if (editingRowId && editingRowId !== serviceCode) {
                cancelEdit(editingRowId);
            }

            editingRowId = serviceCode;
            const row = document.querySelector(`tr[data-id="${serviceCode}"]`);
            row.classList.add('edit-mode');

            const originalData = {
                nama: row.querySelector('[data-field="nama"]').textContent,
                device: row.querySelector('[data-field="device"]').textContent,
                kerusakan: row.querySelector('[data-field="kerusakan"]').textContent,
                nomorHp: row.querySelector('[data-field="nomorHp"]').textContent,
                status: row.querySelector('[data-field="status"]').textContent
            };
            row.setAttribute('data-original-nama', originalData.nama);
            row.setAttribute('data-original-device', originalData.device);
            row.setAttribute('data-original-kerusakan', originalData.kerusakan);
            row.setAttribute('data-original-nomorHp', originalData.nomorHp);
            row.setAttribute('data-original-status', originalData.status);

            row.querySelector('[data-field="nama"]').innerHTML = `<input type="text" value="${originalData.nama}">`;
            row.querySelector('[data-field="device"]').innerHTML = `<input type="text" value="${originalData.device}">`;
            row.querySelector('[data-field="kerusakan"]').innerHTML = `<textarea>${originalData.kerusakan}</textarea>`;
            row.querySelector('[data-field="nomorHp"]').innerHTML = `<input type="tel" value="${originalData.nomorHp}">`;

            const statusSelect = document.createElement('select');
            ['Menunggu', 'Proses', 'Selesai', 'Diambil'].forEach(statusOpt => {
                const option = document.createElement('option');
                option.value = statusOpt;
                option.textContent = statusOpt;
                if (statusOpt === originalData.status) {
                    option.selected = true;
                }
                statusSelect.appendChild(option);
            });
            row.querySelector('[data-field="status"]').innerHTML = '';
            row.querySelector('[data-field="status"]').appendChild(statusSelect);

            row.querySelector('.action-buttons').innerHTML = `
                <button class="save-button" onclick="saveEdit('${serviceCode}')">Simpan</button>
                <button class="cancel-button" onclick="cancelEdit('${serviceCode}')">Batal</button>
            `;
        };

        window.saveEdit = async (serviceCode) => {
            const row = document.querySelector(`tr[data-id="${serviceCode}"]`);
            const updatedNama = row.querySelector('[data-field="nama"] input').value.trim();
            const updatedDevice = row.querySelector('[data-field="device"] input').value.trim();
            const updatedKerusakan = row.querySelector('[data-field="kerusakan"] textarea').value.trim();
            const updatedNomorHp = row.querySelector('[data-field="nomorHp"] input').value.trim();
            const updatedStatus = row.querySelector('[data-field="status"] select').value;

            if (!updatedNama || !updatedDevice || !updatedKerusakan || !updatedNomorHp || !updatedStatus) {
                showModal('Semua kolom wajib diisi!', 'info');
                return;
            }

            if (!/^\d+$/.test(updatedNomorHp) || !updatedNomorHp.startsWith('62')) {
                showModal('Nomor HP tidak valid. Gunakan format dimulai 62 (misal: 62812...) dan hanya angka.', 'info');
                return;
            }

            try {
                const originalTimestamp = servicesData[serviceCode]?.timestamp || new Date().toISOString();

                await set(ref(db, `antrian/${serviceCode}`), {
                    nama: updatedNama,
                    device: updatedDevice,
                    kerusakan: updatedKerusakan,
                    nomorHp: updatedNomorHp,
                    status: updatedStatus,
                    timestamp: originalTimestamp
                });
                showModal("Data berhasil diperbarui!", "info");
                editingRowId = null;
            } catch (error) {
                console.error("Error updating service:", error);
                showModal("Gagal memperbarui data. Silakan coba lagi.", "info");
            }
        };

        window.cancelEdit = (serviceCode) => {
            const row = document.querySelector(`tr[data-id="${serviceCode}"]`);
            row.classList.remove('edit-mode');

            row.querySelector('[data-field="nama"]').innerHTML = row.getAttribute('data-original-nama');
            row.querySelector('[data-field="device"]').innerHTML = row.getAttribute('data-original-device');
            row.querySelector('[data-field="kerusakan"]').innerHTML = row.getAttribute('data-original-kerusakan');
            row.querySelector('[data-field="nomorHp"]').innerHTML = row.getAttribute('data-original-nomorHp');

            const originalStatus = row.getAttribute('data-original-status');
            let statusBadgeClass = '';
            switch (originalStatus) {
                case 'Menunggu': statusBadgeClass = 'status-waiting'; break;
                case 'Proses': statusBadgeClass = 'status-process'; break;
                case 'Selesai': statusBadgeClass = 'status-finished'; break;
                case 'Diambil': statusBadgeClass = 'status-picked-up'; break;
                default: statusBadgeClass = '';
            }
            row.querySelector('[data-field="status"]').innerHTML = `<span class="status-badge ${statusBadgeClass}">${originalStatus}</span>`;

            row.querySelector('.action-buttons').innerHTML = `
                <button class="edit-button" onclick="editRow('${serviceCode}')">Edit</button>
                <button class="delete-button" onclick="deleteService('${serviceCode}')">Hapus</button>
            `;
            editingRowId = null;
        };

        window.deleteService = (serviceCode) => {
            showModal(
                `Apakah Anda yakin ingin menghapus layanan dengan kode ${serviceCode}?`,
                "confirm",
                () => confirmDelete(serviceCode)
            );
        };

        const confirmDelete = async (serviceCode) => {
            closeModal();
            try {
                await remove(ref(db, `antrian/${serviceCode}`));
                showModal("Layanan berhasil dihapus!", "info");
            } catch (error) {
                console.error("Error deleting service:", error);
                showModal("Gagal menghapus layanan. Silakan coba lagi.", "info");
            }
        };

        const customModal = document.getElementById('customModal');
        const modalMessage = document.getElementById('modalMessage');
        const modalButtons = document.getElementById('modalButtons');

        window.showModal = (message, type, callback) => {
            modalMessage.textContent = message;
            modalButtons.innerHTML = '';

            if (type === "info") {
                const okButton = document.createElement('button');
                okButton.textContent = 'OK';
                okButton.className = 'modal-button primary-button';
                okButton.onclick = closeModal;
                modalButtons.appendChild(okButton);
            } else if (type === "confirm") {
                const confirmButton = document.createElement('button');
                confirmButton.textContent = 'Ya';
                confirmButton.className = 'modal-button danger-button';
                confirmButton.onclick = () => {
                    if (callback) callback();
                };
                modalButtons.appendChild(confirmButton);

                const cancelButton = document.createElement('button');
                cancelButton.textContent = 'Tidak';
                cancelButton.className = 'modal-button secondary-button';
                cancelButton.onclick = closeModal;
                modalButtons.appendChild(cancelButton);
            }
            customModal.style.display = 'flex';
        };

        window.closeModal = () => {
            customModal.style.display = 'none';
        };

        window.onclick = (event) => {
            if (event.target == customModal) {
                closeModal();
            }
        };
    </script>
</body>
</html>
